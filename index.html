<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>ArtStation VR</title>
  <meta name="description" content="VR gallery for ArtStation, based on A-Frame.">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/aframe/0.3.2/aframe.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>

<body>
  <a-scene stats class="scene" fog="type: linear; color: #ffffff; far: 32; near: 0">

    <a-entity light="type: ambient; color: #edddec"></a-entity>

    <a-assets>
      <a-asset-item id="mdl_world" src="SM_World.dae"></a-asset-item>
    </a-assets>

    <a-camera fov="90" position="0 0 0" near="0.2" class="player">
      <a-entity cursor="fuse: true; fuseTimeout: 4000" position="0 0 -0.5" scale="0.005 0.005 0.005" geometry="primitive: box" material="color: white; shader: flat"></a-entity>
    </a-camera>

    <a-entity collada-model="#mdl_world" class="world"></a-entity>

  </a-scene>

  <script>

  var scene = document.querySelector('a-scene');
  var player = document.querySelector('.player');

  AFRAME.registerComponent('cursor-listener', {
    init: function() {
      var COLORS = ['red', 'green', 'blue'];
      this.el.addEventListener('click', function (evt) {
        var randomIndex = Math.floor(Math.random() * COLORS.length);
        this.setAttribute('material', 'color', COLORS[randomIndex]);

        // console.log(this.object3D);

        var position = this.getObject3D('mesh').position;
        position.y = 2;

        player.setAttribute('position', position);
      });
    }
  });

  if (scene.hasLoaded) {
    run();
  } else {
    scene.addEventListener('loaded', run);
  }

  var nodes = [];

  var countMax = 0;

  function run() {

    var loader = new THREE.ColladaLoader();

    loader.load('SM_World.dae', function (collada) {

      var model = collada.scene;
      var modelChildren = model.children[1].children;

      countMax = modelChildren.length;

      for (var i = 0; i < modelChildren.length; i++) {
        var modelChild = modelChildren[i];

        var node = {};
        node.position = modelChild.position;
        node.rotation = modelChild.rotation;

        nodes.push(node);
      }
    });

    $.getJSON('ajax.php', function(data) {
      var items = data['data'];

      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var node = nodes[i];

        var imageScale = 1.75;
        var imageAspect = item['cover']['aspect'];

        var imageWidth = imageScale;
        var imageHeight = imageScale / imageAspect;

        var position = new THREE.Vector3(node.position.x, node.position.z, -node.position.y);
        var rotation = new THREE.Euler(node.rotation.x, -node.rotation.z, node.rotation.z, 'XYZ');

        createWaypoint(scene, item, position, rotation);

        position.y = position.y + 2;

        createFrame(scene, item, imageWidth, imageHeight, position, rotation);
        // createPainting(scene, item, imageWidth, imageHeight, position, rotation);
        createPaintingThree(scene, item, imageWidth, imageHeight, position, rotation);

        if (i >= countMax - 1) {
          return false;
        }
      }
    });

  }

  /**
  * Randomize array element order in-place.
  * Using Durstenfeld shuffle algorithm.
  */

  function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }

    return array;
  }

  function createWaypoint(scene, item, position, rotation) {
    var el = document.createElement('a-box');

    el.setAttribute('cursor-listener', null);

    var mesh = el.getOrCreateObject3D('mesh', THREE.Mesh);

    mesh.position.set(position.x, position.y, position.z);

    mesh.rotateY(rotation.y);
    mesh.translateZ(0.75);

    mesh.scale.y = 0.25;

    el.setObject3D('mesh', mesh);
    scene.appendChild(el);
  }

  function createFrame(scene, item, imageWidth, imageHeight, position, rotation) {
    var el = document.createElement('a-box');

    el.setAttribute('material', 'color', '#222222');

    var mesh = el.getOrCreateObject3D('mesh', THREE.Mesh);

    var frameSize = 0.35;

    mesh.scale.x = imageWidth + frameSize;
    mesh.scale.y = imageHeight + frameSize;
    mesh.scale.z = 0.05;

    mesh.position.set(position.x, position.y, position.z);

    mesh.rotateY(rotation.y);
    mesh.translateZ(-0.95);

    el.setObject3D('mesh', mesh);
    scene.appendChild(el);
  }

  function createPainting(scene, item, imageWidth, imageHeight, position, rotation) {
    var el = document.createElement('a-image');

    el.setAttribute('src', item['cover']['medium_image_url']);

    var mesh = el.getOrCreateObject3D('mesh', THREE.Mesh);

    mesh.scale.x = imageWidth;
    mesh.scale.y = imageHeight;

    mesh.position.set(position.x, position.y, position.z);

    mesh.rotateY(rotation.y);
    mesh.translateZ(-0.92);

    el.setObject3D('mesh', mesh);
    scene.appendChild(el);
  }

  function createPaintingThree(scene, item, imageWidth, imageHeight, position, rotation) {
    var el = document.createElement('a-entity');

    var texture = new THREE.TextureLoader().load(item['cover']['medium_image_url']);
    texture.minFilter = THREE.LinearFilter;

    var geometry = new THREE.PlaneGeometry(imageWidth, imageHeight, 1);
    var material = new THREE.MeshBasicMaterial({color: 0xffffff, map: texture, side: THREE.FrontSide});
    var mesh = new THREE.Mesh(geometry, material);

    mesh.position.set(position.x, position.y, position.z);

    mesh.rotateY(rotation.y);
    mesh.translateZ(-0.92);

    el.setObject3D('mesh', mesh);

    scene.appendChild(el);
  }

  </script>

</body>
</html>
