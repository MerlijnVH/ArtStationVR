<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>ArtStation VR</title>
  <meta name="description" content="VR gallery for ArtStation, based on A-Frame.">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/aframe/0.3.2/aframe.min.js"></script>
  <script type="text/javascript" src="https://rawgit.com/bryik/aframe-bmfont-text-component/master/dist/aframe-bmfont-text-component.min.js"></script>
</head>

<body>
  <a-scene stats class="scene" fog="type: linear; color: #ffffff; far: 32; near: 0">

    <a-entity light="type: ambient; color: #ffffff"></a-entity>

    <a-assets>
      <a-asset-item id="mdl_world" src="SM_World.dae"></a-asset-item>
    </a-assets>

    <a-camera fov="90" position="0 0 0" near="0.2" class="player">
      <a-entity cursor="fuse: true; fuseTimeout: 4000" position="0 0 -0.5" scale="0.005 0.005 0.005" geometry="primitive: box" material="color: white; shader: flat"></a-entity>
    </a-camera>

    <a-entity collada-model="#mdl_world" class="world"></a-entity>
    <a-entity bmfont-text="text: Hello world" class="text"></a-entity>

  </a-scene>

  <script>

  var scene = document.querySelector('a-scene');
  var player = document.querySelector('.player');
  var text = document.querySelector('.text');

  scene.addEventListener('loaded', initializeScene);

  var nodes = [];
  var countMax = 0;

  AFRAME.registerComponent('cursor-listener', {
    schema: {
      type: 'array', default: null
    },
    init: function() {
      this.el.addEventListener('click', function (evt) {
        var mesh = this.getObject3D('mesh');

        console.log(this.components['cursor-listener'].attrValue);

        var texture = new THREE.TextureLoader().load('walk.png');
        texture.minFilter = THREE.LinearFilter;

        var material = new THREE.MeshBasicMaterial({color: 0x707070, map: texture, side: THREE.FrontSide});

        mesh.material = material;

        var position = mesh.position;
        var tempPosition = new THREE.Vector3(position.x, position.y + 2, position.z);

        text.setAttribute('position', tempPosition);

        player.setAttribute('position', tempPosition);
      });
    }
  });

  function render() {
    console.log('eeee');
    requestAnimationFrame(render);
  }

  function initializeScene() {

    var startPosition = new THREE.Vector3(0, 2, 0);
    player.setAttribute('position', startPosition);

    var loader = new THREE.ColladaLoader();

    loader.load('SM_World.dae', function (collada) {
      var model = collada.scene;
      var modelChildren = model.children[1].children;

      countMax = modelChildren.length;

      for (var i = 0; i < modelChildren.length; i++) {
        var modelChild = modelChildren[i];

        var node = {};
        node.position = modelChild.position;
        node.rotation = modelChild.rotation;

        nodes.push(node);
      }
    });

    loader.load('SM_ArtStation.dae', function (collada) {
      var model = collada.scene;
      var object3D = model.children[0];

      var el = document.createElement('a-entity');

      object3D.translateY(2);
      object3D.rotateX((Math.PI / 2) * 3);

      var material = new THREE.MeshPhongMaterial({color: 0x0099ff, emissive: 0x0099ff});
      object3D.children[0].material = material;

      console.log(object3D);

      el.setObject3D('object3D', object3D);
      scene.appendChild(el);
    });

    var requestURL = 'server/feed.php';
    var request = new XMLHttpRequest();
    request.open('GET', requestURL, true);

    request.onload = function() {
      if (request.status >= 200 && request.status < 400) {
        var data = JSON.parse(request.responseText);

        var items = data['data'];

        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          var node = nodes[i];

          var imageScale = 1.5;
          var imageAspect = item['cover']['aspect'];

          var imageWidth = imageScale;
          var imageHeight = imageScale / imageAspect;

          if (imageAspect > 1) {
            imageWidth = imageScale * imageAspect;
            imageHeight = imageScale;
          }

          var position = new THREE.Vector3(node.position.x, node.position.z, -node.position.y);
          var rotation = new THREE.Euler(node.rotation.x, -node.rotation.z, node.rotation.z, 'XYZ');

          createWaypoint(scene, item, position, rotation);

          position.y = position.y + 2;

          createFrame(scene, item, imageWidth, imageHeight, position, rotation);
          createPaintingThree(scene, item, imageWidth, imageHeight, position, rotation);

          if (i >= countMax - 1) {
            return false;
          }
        }
      } else {
        // We reached our target server, but it returned an error
      }
    };

    request.onerror = function() {
      // There was a connection error of some sort
    };

    request.send();
  }

  // Randomize array element order in-place
  // Using Durstenfeld shuffle algorithm

  function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = array[i];
      array[i] = array[j];
      array[j] = temp;
    }

    return array;
  }

  function createWaypoint(scene, item, position, rotation) {
    var el = document.createElement('a-entity');

    el.setAttribute('cursor-listener', item);

    var texture = new THREE.TextureLoader().load('walk.png');
    texture.minFilter = THREE.LinearFilter;

    var geometry = new THREE.CircleGeometry(0.75, 8);
    var material = new THREE.MeshBasicMaterial({color: 0xffffff, map: texture, side: THREE.FrontSide});
    var mesh = new THREE.Mesh(geometry, material);

    mesh.position.set(position.x, position.y + 0.0025, position.z);

    mesh.rotateY(rotation.y);
    mesh.rotateX(-(Math.PI / 2));
    mesh.translateY(-0.75);

    el.setObject3D('mesh', mesh);
    scene.appendChild(el);
  }

  function createFrame(scene, item, imageWidth, imageHeight, position, rotation) {
    var el = document.createElement('a-entity');

    var frameSize = 0.35;

    var geometry = new THREE.BoxGeometry(imageWidth + frameSize, imageHeight + frameSize, 0.05);
    var material = new THREE.MeshBasicMaterial({color: 0x222222, side: THREE.FrontSide});
    var mesh = new THREE.Mesh(geometry, material);

    mesh.position.set(position.x, position.y, position.z);

    mesh.rotateY(rotation.y);
    mesh.translateZ(-0.95);

    el.setObject3D('mesh', mesh);
    scene.appendChild(el);
  }

  function createPainting(scene, item, imageWidth, imageHeight, position, rotation) {
    var el = document.createElement('a-image');

    el.setAttribute('src', item['cover']['medium_image_url']);

    var mesh = el.getOrCreateObject3D('mesh', THREE.Mesh);

    mesh.scale.x = imageWidth;
    mesh.scale.y = imageHeight;

    mesh.position.set(position.x, position.y, position.z);

    mesh.rotateY(rotation.y);
    mesh.translateZ(-0.92);

    el.setObject3D('mesh', mesh);
    scene.appendChild(el);
  }

  function createPaintingThree(scene, item, imageWidth, imageHeight, position, rotation) {
    var el = document.createElement('a-entity');

    var texture = new THREE.TextureLoader().load(item['cover']['medium_image_url']);
    texture.minFilter = THREE.LinearFilter;

    var geometry = new THREE.PlaneGeometry(imageWidth, imageHeight, 1);
    var material = new THREE.MeshBasicMaterial({color: 0xffffff, map: texture, side: THREE.FrontSide});
    var mesh = new THREE.Mesh(geometry, material);

    mesh.position.set(position.x, position.y, position.z);

    mesh.rotateY(rotation.y);
    mesh.translateZ(-0.92);

    el.setObject3D('mesh', mesh);
    scene.appendChild(el);
  }

  </script>

</body>
</html>
